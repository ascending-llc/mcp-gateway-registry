version: '3.8'

services:
  # OpenTelemetry Collector
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./config/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4318:4318"   # OTLP HTTP receiver
      - "4317:4317"   # OTLP gRPC receiver
      - "8889:8889"   # Prometheus exporter (optional)
    restart: unless-stopped
    profiles:
      - full

  # Registry service (includes nginx, SSL, FAISS, models)
  registry:
    build:
      context: .
      dockerfile: docker/Dockerfile.registry
      args:
        TOOL_DISCOVERY_MODE: ${TOOL_DISCOVERY_MODE:-embedded}
        BUILD_VERSION: ${BUILD_VERSION:-}
        SCHEMA_VERSION: ${SCHEMA_VERSION:-}
        GITHUB_TOKEN: ${GITHUB_TOKEN:-}
    networks:
      default:
        aliases:
          - mcpgateway-registry
    environment:
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - HEALTH_CHECK_INTERVAL_SECONDS=${HEALTH_CHECK_INTERVAL_SECONDS:-30}
      - SRE_GATEWAY_AUTH_TOKEN=${SRE_GATEWAY_AUTH_TOKEN}
      - ATLASSIAN_AUTH_TOKEN=${ATLASSIAN_AUTH_TOKEN}
      # Metrics configuration
      - METRICS_SERVICE_URL=http://metrics-service:8890
      - METRICS_API_KEY=${METRICS_API_KEY_REGISTRY}
      - METRICS_API_KEY_NGINX=${METRICS_API_KEY_REGISTRY}
      - AUTH_SERVER_URL=http://auth-server:8888
      # External Registry Configuration
      - EXTERNAL_REGISTRY_TAGS=${EXTERNAL_REGISTRY_TAGS:-anthropic-registry,workday-asor}
      - ASOR_ACCESS_TOKEN=${ASOR_ACCESS_TOKEN}
      - ASOR_CLIENT_CREDENTIALS=${ASOR_CLIENT_CREDENTIALS}
      # Security Scanning Configuration
      - SECURITY_SCAN_ENABLED=${SECURITY_SCAN_ENABLED:-true}
      - SECURITY_SCAN_ON_REGISTRATION=${SECURITY_SCAN_ON_REGISTRATION:-true}
      - SECURITY_BLOCK_UNSAFE_SERVERS=${SECURITY_BLOCK_UNSAFE_SERVERS:-true}
      - SECURITY_ANALYZERS=${SECURITY_ANALYZERS:-yara}
      - SECURITY_SCAN_TIMEOUT=${SECURITY_SCAN_TIMEOUT:-60}
      - SECURITY_ADD_PENDING_TAG=${SECURITY_ADD_PENDING_TAG:-true}
      - MCP_SCANNER_LLM_API_KEY=${MCP_SCANNER_LLM_API_KEY}
      - MONGO_URI=mongodb://registry-mongodb:27017/jarvis
      # Sends logs to OpenTelemetry Collector
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_SERVICE_NAME=mcp-gateway-registry

      # Embeddings Configuration
      # - EMBEDDINGS_PROVIDER=${EMBEDDINGS_PROVIDER:-sentence-transformers}
      # - EMBEDDINGS_MODEL_NAME=${EMBEDDINGS_MODEL_NAME:-all-MiniLM-L6-v2}
      # - EMBEDDINGS_MODEL_DIMENSIONS=${EMBEDDINGS_MODEL_DIMENSIONS:-384}
      # - EMBEDDINGS_API_KEY=${EMBEDDINGS_API_KEY}
      # - EMBEDDINGS_API_BASE=${EMBEDDINGS_API_BASE}
      # - EMBEDDINGS_AWS_REGION=${EMBEDDINGS_AWS_REGION:-us-east-1}
    ports:
      - "7860:7860"
    volumes:
      - ./registry/logs:/app/logs
      - ./security_scans:/app/security_scans
      - ./auth_server/scopes.yml:/app/auth_server/scopes.yml
      - ./auth_server/oauth2_providers.yml:/app/oauth2_providers.yml
      - ${APP_HOME}/mcp-gateway/federation.json:/app/config/federation.json
    depends_on:
      auth-server:
        condition: service_started
      metrics-service:
        condition: service_healthy
      weaviate:
        condition: service_healthy
      registry-mongodb:
        condition: service_healthy
      registry-redis:
        condition: service_started
    restart: unless-stopped
    env_file:
      - .env
    profiles:
      - full

  # Registry Frontend
  registry-frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.registry-frontend
    environment:
      - NGINX_BASE_PATH=${NGINX_BASE_PATH:-}
      - AUTH_SERVER_URL=http://auth-server:8888
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - registry
    restart: unless-stopped
    env_file:
      - .env
    profiles:
      - full
  
  # MongoDB Database
  registry-mongodb:
    container_name: registry-mongodb
    image: mongo:8.0.17
    restart: always
    #user: "${UID:-1000}:${GID:-1000}" # The default user does not have permission to run the program on the mount path.
    environment:
      - MONGO_INITDB_DATABASE=${MONGODB_DB_NAME:-jarvis}
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
    command: mongod --noauth
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    profiles:
      - full
      - dev

  registry-redis:
    container_name: registry-redis
    image: redis:latest
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: always
    command: redis-server --appendonly yes
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5
    profiles:
        - full
        - dev
  # Auth service (separate and scalable)
  auth-server:
    build:
      context: .
      dockerfile: docker/Dockerfile.auth
    environment:
      - AWS_REGION=${AWS_REGION:-us-east-1}
      # Metrics configuration
      - METRICS_SERVICE_URL=http://metrics-service:8890
      - METRICS_API_KEY=${METRICS_API_KEY_AUTH_SERVER}
      # Keycloak configuration
      - AUTH_PROVIDER=${AUTH_PROVIDER:-cognito}  # 'cognito' or 'keycloak' or 'entra'
      - KEYCLOAK_ENABLED=${KEYCLOAK_ENABLED:-false}
      - KEYCLOAK_URL=${KEYCLOAK_URL:-http://keycloak:8080}
      - KEYCLOAK_EXTERNAL_URL=${KEYCLOAK_EXTERNAL_URL:-http://localhost:8080}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM:-mcp-gateway}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID:-mcp-gateway-web}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
      - KEYCLOAK_M2M_CLIENT_ID=${KEYCLOAK_M2M_CLIENT_ID:-mcp-gateway-m2m}
      - KEYCLOAK_M2M_CLIENT_SECRET=${KEYCLOAK_M2M_CLIENT_SECRET}
      # Microsoft Entra ID (Azure AD) configuration
      - ENTRA_TENANT_ID=${ENTRA_TENANT_ID}
      - ENTRA_CLIENT_ID=${ENTRA_CLIENT_ID}
      - ENTRA_CLIENT_SECRET=${ENTRA_CLIENT_SECRET}
      # Optional: Claim mappings - customize based on your Entra ID setup
      - ENTRA_USERNAME_CLAIM=${ENTRA_USERNAME_CLAIM:-preferred_username}
      - ENTRA_GROUPS_CLAIM=${ENTRA_GROUPS_CLAIM:-groups}
      - ENTRA_EMAIL_CLAIM=${ENTRA_EMAIL_CLAIM:-upn}
      - ENTRA_NAME_CLAIM=${ENTRA_NAME_CLAIM:-name}
      - ENTRA_ROLE_TOKEN_KIND=${ENTRA_ROLE_TOKEN_KIND:-id}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_SERVICE_NAME=auth-server
      - REGISTRY_CLIENT_URL=${REGISTRY_CLIENT_URL:-http://registry-frontend}
    ports:
      - "8888:8888"
    volumes:
      - ./auth_server/logs:/app/logs
      - ./auth_server/scopes.yml:/app/scopes.yml
      - ./auth_server/oauth2_providers.yml:/app/oauth2_providers.yml
    restart: unless-stopped
    env_file:
      - .env
    profiles:
      - full
      - dev

  # Current Time MCP Server
  currenttime-server:
    build:
      context: servers/currenttime
      dockerfile: ../../docker/Dockerfile.mcp-server
    environment:
      - PORT=8000
      - MCP_TRANSPORT=streamable-http
    ports:
      - "8000:8000"
    restart: unless-stopped
    profiles:
      - full

  # MCP Gateway Server
  mcpgw-server:
    build:
      context: .
      dockerfile: docker/Dockerfile.mcpgw
      args:
        TOOL_DISCOVERY_MODE: ${TOOL_DISCOVERY_MODE:-embedded}
        BUILD_VERSION: ${BUILD_VERSION:-}
        SCHEMA_VERSION: ${SCHEMA_VERSION:-}
        GITHUB_TOKEN: ${GITHUB_TOKEN:-}
    environment:
      - PORT=8003
      - REGISTRY_BASE_URL=http://registry:7860
      - REGISTRY_USERNAME=${ADMIN_USER:-admin}
      - REGISTRY_PASSWORD=${ADMIN_PASSWORD}
      - JWT_SECRET_KEY=${SECRET_KEY}
      - WEAVIATE_HOST=weaviate
      # MongoDB configuration
      - MONGO_URI=mongodb://registry-mongodb:27017/jarvis
    volumes:
      - ./auth_server/scopes.yml:/app/auth_server/scopes.yml
    ports:
      - "8003:8003"
    #    depends_on:
    #      - registry
    restart: unless-stopped
    env_file:
      - .env
    profiles:
      - full
      - dev
  weaviate:
    image: cr.weaviate.io/semitechnologies/weaviate:latest
    restart: on-failure:0
    ports:
      - 8099:8080
      # - 50051:50051
    env_file:
      - .env
    volumes:
      - weaviate_data:/var/lib/weaviate
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/v1/.well-known/ready" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    profiles:
      - full
      - dev

  # SQLite container for metrics database
  metrics-db:
    image: alpine:latest
    volumes:
      - metrics-db-data:/var/lib/sqlite
    command: [ "sh", "-c", "apk add --no-cache sqlite && mkdir -p /var/lib/sqlite && sqlite3 /var/lib/sqlite/metrics.db 'CREATE TABLE IF NOT EXISTS _health (id INTEGER);' && tail -f /dev/null" ]
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "sqlite3", "/var/lib/sqlite/metrics.db", ".tables" ]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - full

  # Prometheus for metrics collection
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    restart: unless-stopped
    profiles:
      - full

  # Grafana for metrics visualization
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./config/grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - prometheus
    restart: unless-stopped
    profiles:
      - full

  # PostgreSQL database for Keycloak
  keycloak-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak}
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U keycloak" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Keycloak Identity Provider
  keycloak:
    image: quay.io/keycloak/keycloak:25.0
    command: start-dev  # Use 'start' for production with proper SSL
    environment:
      # Database configuration
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD:-keycloak}

      # Admin credentials
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}

      # HTTP configuration
      KC_HTTP_ENABLED: 'true'
      KC_HTTP_PORT: 8080
      KC_HOSTNAME_STRICT: 'false'
      KC_HOSTNAME_STRICT_HTTPS: 'false'
      KC_PROXY: edge  # Running behind nginx

      # Frontend URL for external JWT issuer
      KC_FRONTEND_URL: ${KEYCLOAK_EXTERNAL_URL:-http://localhost:8080}

      # Features
      KC_FEATURES: token-exchange,admin-api

      # Logging
      KC_LOG_LEVEL: INFO

    ports:
      - "8080:8080"
    depends_on:
      keycloak-db:
        condition: service_healthy
    volumes:
      - ./keycloak/themes:/opt/keycloak/themes
      - ./keycloak/providers:/opt/keycloak/providers
      - ./keycloak/import:/opt/keycloak/data/import
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health/ready" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  ssl_data:
  keycloak_db_data:
  mongodb-data:
    driver: local
  mongodb-config:
    driver: local
  metrics-db-data:
  prometheus-data:
  grafana-data:
  weaviate_data:
    driver: local
  redis_data:
    driver: local