name: Sync Fork with Upstream

on:
  workflow_dispatch: # Manual trigger - adds "Run workflow" button in GitHub UI
    inputs:
      create_pr:
        description: 'Create a draft PR to main after sync?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      upstream_branch:
        description: 'Upstream branch to sync from'
        required: false
        default: 'main'
        type: string

jobs:
  sync-fork:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/agentic-community/mcp-gateway-registry.git || true
          echo "âœ… Added upstream remote"

      - name: Fetch all remotes
        run: |
          git fetch --all
          echo "âœ… Fetched all remotes"

      - name: Create/update fork-sync branch
        run: |
          UPSTREAM_BRANCH="${{ github.event.inputs.upstream_branch || 'main' }}"
          echo "ðŸ”„ Syncing with upstream/${UPSTREAM_BRANCH}"
          
          # Create or reset fork-sync to match upstream
          git checkout -B fork-sync upstream/${UPSTREAM_BRANCH}
          
          # Get commit info for summary
          LATEST_COMMIT=$(git log --oneline -1)
          echo "ðŸ“ Latest upstream commit: ${LATEST_COMMIT}"
          
          # Push to origin (your fork)
          git push origin fork-sync --force
          echo "âœ… Updated fork-sync branch successfully"
          
          # Store commit info for PR
          echo "LATEST_COMMIT=${LATEST_COMMIT}" >> $GITHUB_ENV
          echo "UPSTREAM_BRANCH=${UPSTREAM_BRANCH}" >> $GITHUB_ENV

      - name: Check for differences with main
        id: check_diff
        run: |
          # Check if there are differences between fork-sync and main
          if git diff --quiet origin/main fork-sync; then
            echo "ðŸ“‹ No differences found between main and upstream"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“‹ Changes detected between main and upstream"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Get summary of changes
            CHANGES=$(git log --oneline origin/main..fork-sync | head -10)
            echo "CHANGES<<EOF" >> $GITHUB_ENV
            echo "${CHANGES}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: Create Pull Request
        if: steps.check_diff.outputs.has_changes == 'true' && (github.event.inputs.create_pr == 'true' || github.event.inputs.create_pr == '')
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: fork-sync
          title: "ðŸ”„ Sync fork with upstream/${{ env.UPSTREAM_BRANCH }}"
          body: |
            ## ðŸ”„ Fork Sync Update
            
            This PR syncs our fork with the upstream repository.
            
            **Latest upstream commit:** `${{ env.LATEST_COMMIT }}`
            
            ### ðŸ“‹ Recent upstream changes:
            ```
            ${{ env.CHANGES }}
            ```
            
            ### âš ï¸ Before merging:
            - [ ] Review all changes carefully
            - [ ] Test in development environment
            - [ ] Check for breaking changes
            - [ ] Verify compatibility with custom features
            
            ---
            ðŸ¤– Auto-generated by [Sync Fork GitHub Action](.github/workflows/sync-fork.yml)
            
            **Triggered:** Manually
            **Date:** ${{ github.run_id }}
          draft: true
          delete-branch: false
          labels: |
            sync
            upstream
            automated

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Fork Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** Successfully synced with upstream/${{ env.UPSTREAM_BRANCH }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ¿ **Branch:** \`fork-sync\` updated" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Latest commit:** \`${{ env.LATEST_COMMIT }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_diff.outputs.has_changes }}" == "true" ]; then
            echo "ðŸ”„ **Changes:** Found differences with main" >> $GITHUB_STEP_SUMMARY
            if [ "${{ github.event.inputs.create_pr }}" != "false" ]; then
              echo "ðŸ“¬ **PR:** Draft PR created for review" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ðŸ“‹ **Changes:** No new changes from upstream" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the \`fork-sync\` branch" >> $GITHUB_STEP_SUMMARY
          echo "2. Check the draft PR (if created)" >> $GITHUB_STEP_SUMMARY
          echo "3. Test changes before merging to main" >> $GITHUB_STEP_SUMMARY