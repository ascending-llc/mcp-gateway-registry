name: Build and Push Docker Images (Reusable)

on:
  workflow_call:
    inputs:
      region:
        description: 'AWS Region'
        type: string
        required: true
        default: us-east-1
      git_ref:
        description: 'Git ref to checkout (commit SHA, tag, or branch)'
        type: string
        required: false
        default: ''
      version_tag:
        description: 'Optional version tag for images'
        type: string
        required: false
        default: ''
    secrets:
      AWS_DEPLOY_ROLE_ARN:
        required: true
      JARVIS_RELEASE_ACCESS_TOKEN:
        required: true

permissions:
  id-token: write 
  contents: read

jobs:
  get-schema-version:
    runs-on: ubuntu-latest
    outputs:
      schema_version: ${{ steps.schema.outputs.schema_version }}
    steps:
      - name: Get latest schema version
        id: schema
        run: |
          # Get the latest release tag from jarvis-api repo (private repo)
          # Using PAT for cross-repo access to private repository
          SCHEMA_VERSION=$(gh api repos/ascending-llc/jarvis-api/releases/latest --jq '.tag_name' || echo "")
          
          if [ -z "$SCHEMA_VERSION" ]; then
            echo "⚠️  Error: Failed to fetch latest release from jarvis-api"
            echo "This could mean:"
            echo "  1. The repository has no releases published yet"
            echo "  2. The PAT doesn't have access to ascending-llc/jarvis-api"
            exit 1
          fi
          
          echo "schema_version=${SCHEMA_VERSION}" >> $GITHUB_OUTPUT
          echo "✅ Using SCHEMA_VERSION: ${SCHEMA_VERSION}"
        env:
          GITHUB_TOKEN: ${{ secrets.JARVIS_RELEASE_ACCESS_TOKEN }}

  build-and-push-mcpgateway:
    needs: get-schema-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref || github.sha }}
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Assume IAM role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: deployment-role-session
          aws-region: ${{ inputs.region }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine image tags
        id: tags
        run: |
          COMMIT_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/mcpgateway:${{ github.sha }}"
          LATEST_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/mcpgateway:latest"
          
          if [ -n "${{ inputs.version_tag }}" ]; then
            VERSION_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/mcpgateway:${{ inputs.version_tag }}"
            echo "tags=${VERSION_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          else
            echo "tags=${LATEST_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Build and push mcp-gateway server image
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64
          context: .
          file: docker/Dockerfile.mcpgw
          build-args: |
            TOOL_DISCOVERY_MODE=external
            SCHEMA_VERSION=${{ needs.get-schema-version.outputs.schema_version }}
            GITHUB_TOKEN=${{ secrets.JARVIS_RELEASE_ACCESS_TOKEN }}
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          provenance: false

  build-and-push-registry:
    needs: get-schema-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref || github.sha }}
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Assume IAM role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: deployment-role-session
          aws-region: ${{ inputs.region }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine BUILD_VERSION
        id: version
        run: |
          if [ -n "${{ inputs.version_tag }}" ]; then
            echo "version=${{ inputs.version_tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT
          fi

      - name: Determine image tags
        id: tags
        run: |
          COMMIT_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/registry:${{ github.sha }}"
          LATEST_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/registry:latest"
          
          if [ -n "${{ inputs.version_tag }}" ]; then
            VERSION_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/registry:${{ inputs.version_tag }}"
            echo "tags=${VERSION_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          else
            echo "tags=${LATEST_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Build and push mcp-gateway registry image
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64
          context: .
          file: docker/Dockerfile.registry
          build-args: |
            TOOL_DISCOVERY_MODE=external
            BUILD_VERSION=${{ steps.version.outputs.version }}
            SCHEMA_VERSION=${{ steps.schema.outputs.schema_version }}
            GITHUB_TOKEN=${{ secrets.JARVIS_RELEASE_ACCESS_TOKEN }}
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          provenance: false

  build-and-push-registry-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref || github.sha }}
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Assume IAM role
        uses: aws-actions/confineeds.get-schema-versiondentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: deployment-role-session
          aws-region: ${{ inputs.region }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine image tags
        id: tags
        run: |
          COMMIT_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/registry-frontend:${{ github.sha }}"
          LATEST_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/registry-frontend:latest"
          
          if [ -n "${{ inputs.version_tag }}" ]; then
            VERSION_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/registry-frontend:${{ inputs.version_tag }}"
            echo "tags=${VERSION_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          else
            echo "tags=${LATEST_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Build and push mcp-gateway registry frontend image
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64
          context: .
          file: docker/Dockerfile.registry-frontend
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          provenance: false

  build-and-push-auth-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref || github.sha }}
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Assume IAM role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: deployment-role-session
          aws-region: ${{ inputs.region }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine image tags
        id: tags
        run: |
          COMMIT_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/auth-server:${{ github.sha }}"
          LATEST_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/auth-server:latest"
          
          if [ -n "${{ inputs.version_tag }}" ]; then
            VERSION_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/auth-server:${{ inputs.version_tag }}"
            echo "tags=${VERSION_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          else
            echo "tags=${LATEST_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Build and push mcp-gateway auth-server image
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64
          context: .
          file: docker/Dockerfile.auth
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          provenance: false
