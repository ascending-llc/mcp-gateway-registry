name: Build and Push Docker Images (Reusable)

on:
  workflow_call:
    inputs:
      region:
        description: 'AWS Region'
        type: string
        required: true
        default: us-east-1
      git_ref:
        description: 'Git ref to checkout (commit SHA, tag, or branch)'
        type: string
        required: false
        default: ''
      version_tag:
        description: 'Optional version tag for images'
        type: string
        required: false
        default: ''
    secrets:
      AWS_DEPLOY_ROLE_ARN:
        required: true
      JARVIS_RELEASE_ACCESS_TOKEN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  prepare-artifacts:
    runs-on: ubuntu-latest
    outputs:
      schema_version: ${{ steps.schema.outputs.schema-version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Get latest schema version
        id: schema
        uses: ./.github/actions/get-schema-version
        with:
          github-token: ${{ secrets.JARVIS_RELEASE_ACCESS_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Generate registry-pkgs model code from schemas
        run: >
          uv run --package registry-pkgs import-schemas
          --tag "${{ steps.schema.outputs.schema-version }}"
          --output-dir ./registry-pkgs/src/registry_pkgs/models
          --token "${{ secrets.JARVIS_RELEASE_ACCESS_TOKEN }}"

      - name: Display generated model code
        run: ls -al ./registry-pkgs/src/registry_pkgs/models/_generated/

      - name: Build artifacts
        run: uv run poe build-artifacts

      - name: Display artifacts
        run: ls -al build-artifacts

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: wheels-and-locks
          path: build-artifacts/
          retention-days: 1

  build-and-push-mcpgateway:
    needs: prepare-artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref || github.sha }}
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Assume IAM role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: deployment-role-session
          aws-region: ${{ inputs.region }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine image tags
        id: tags
        run: |
          COMMIT_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/mcpgateway:${{ github.sha }}"
          LATEST_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/mcpgateway:latest"

          if [ -n "${{ inputs.version_tag }}" ]; then
            VERSION_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/mcpgateway:${{ inputs.version_tag }}"
            echo "tags=${VERSION_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          else
            echo "tags=${LATEST_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Download build artifact - wheels and locks
        uses: actions/download-artifact@v7
        with:
          name: wheels-and-locks
          path: build-artifacts/

      - name: Display artifacts
        run: ls -al build-artifacts

      - name: Build and push mcp-gateway server image
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64
          context: .
          file: docker/Dockerfile.mcpgw
          build-args: |
            TOOL_DISCOVERY_MODE=external
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          provenance: false

      - name: Guard the Docker image against import exceptions
        run: >
          docker run --rm --entrypoint=''
          "${{ steps.login-ecr.outputs.registry }}/jarvis/mcpgateway:${{ github.sha }}"
          python -c "from mcpgw.server import main; print(type(main))"

  build-and-push-registry:
    needs: prepare-artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref || github.sha }}
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Assume IAM role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: deployment-role-session
          aws-region: ${{ inputs.region }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine BUILD_VERSION
        id: version
        run: |
          if [ -n "${{ inputs.version_tag }}" ]; then
            echo "version=${{ inputs.version_tag }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_SHA:0:8}" >> $GITHUB_OUTPUT
          fi

      - name: Determine image tags
        id: tags
        run: |
          COMMIT_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/registry:${{ github.sha }}"
          LATEST_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/registry:latest"

          if [ -n "${{ inputs.version_tag }}" ]; then
            VERSION_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/registry:${{ inputs.version_tag }}"
            echo "tags=${VERSION_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          else
            echo "tags=${LATEST_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Download build artifact - wheels and locks
        uses: actions/download-artifact@v7
        with:
          name: wheels-and-locks
          path: build-artifacts/

      - name: Display artifacts
        run: ls -al build-artifacts

      - name: Build and push mcp-gateway registry image
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64
          context: .
          file: docker/Dockerfile.registry
          build-args: |
            TOOL_DISCOVERY_MODE=external
            BUILD_VERSION=${{ steps.version.outputs.version }}
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          provenance: false

      - name: Guard the Docker image against import exceptions
        run: >
          docker run --rm --entrypoint='' -e BUILD_VERSION=dummy
          -e SECRET_KEY=dummy -e ADMIN_PASSWORD=dummy -e ADMIN_USER=dummy
          "${{ steps.login-ecr.outputs.registry }}/jarvis/registry:${{ github.sha }}"
          python -c "from registry.main import app; print(type(app))"

  build-and-push-registry-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref || github.sha }}
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Assume IAM role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: deployment-role-session
          aws-region: ${{ inputs.region }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine image tags
        id: tags
        run: |
          COMMIT_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/registry-frontend:${{ github.sha }}"
          LATEST_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/registry-frontend:latest"

          if [ -n "${{ inputs.version_tag }}" ]; then
            VERSION_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/registry-frontend:${{ inputs.version_tag }}"
            echo "tags=${VERSION_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          else
            echo "tags=${LATEST_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Build and push mcp-gateway registry frontend image
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64
          context: .
          file: docker/Dockerfile.registry-frontend
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          provenance: false

  build-and-push-auth-server:
    needs: prepare-artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref || github.sha }}
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Assume IAM role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: deployment-role-session
          aws-region: ${{ inputs.region }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Determine image tags
        id: tags
        run: |
          COMMIT_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/auth-server:${{ github.sha }}"
          LATEST_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/auth-server:latest"

          if [ -n "${{ inputs.version_tag }}" ]; then
            VERSION_TAG="${{ steps.login-ecr.outputs.registry }}/jarvis/auth-server:${{ inputs.version_tag }}"
            echo "tags=${VERSION_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          else
            echo "tags=${LATEST_TAG},$COMMIT_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Download build artifact - wheels and locks
        uses: actions/download-artifact@v7
        with:
          name: wheels-and-locks
          path: build-artifacts/

      - name: Display artifacts
        run: ls -al build-artifacts

      - name: Build and push mcp-gateway auth-server image
        uses: docker/build-push-action@v6
        with:
          platforms: linux/amd64
          context: .
          file: docker/Dockerfile.auth
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          provenance: false

      - name: Guard the Docker image against import exceptions
        run: >
          docker run --rm --entrypoint=''
          "${{ steps.login-ecr.outputs.registry }}/jarvis/auth-server:${{ github.sha }}"
          python -c "from auth_server.server import app; print(type(app))"
