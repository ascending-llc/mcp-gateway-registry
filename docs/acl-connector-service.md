# AS-1376

## Introduction

Currently, all end users have access to the same set of MCP servers and A2A agents. Customers would like full control over which connectors are visible to which users. To satisify this requirement, we will introduce an access control list (ACL) service in the MCP registry project that will define object-level permissions for all servers & A2A agents. 

## Objectives

Design an ACL service that allows admins to share a connector with:

- Everyone 
- Specific user groups (development, sales, HR, etc.)
- Specific users (TODO: Put example of a user-specific example)

This service should be compitable with the existing data models and interfaces used in jarvis-api

## Registry ACL Design

### Data Model
The ACL data model is defined in the Jarvis-API project (`packages/data-schemas/src/types/aclEntry.ts`). The `import-schema` tool will be used to ensure the registry project uses compatiable models:

Generated ACL Document Model - `mcp-gateway-registry/packages/models/_generated/aclEntry.py`

```python
class IAclEntry(Document):
    """
    IAclEntry Model
    
    Generated from: aclEntry.ts
    Schema version: asc0.4.0
    Generated at: 2025-12-28T16:00:02.739426Z
    """

    principalType: str = Field(...)
    principalId: Optional[Dict[str, Any]] = Field(default=None)
    principalModel: Optional[str] = Field(default=None)
    resourceType: str = Field(...)
    resourceId: PydanticObjectId = Field(...)
    permBits: Optional[float] = Field(default=1)
    roleId: Optional[PydanticObjectId] = Field(default=None, pattern=r"^[0-9a-fA-F]{24}$")  # references IAccessRole collection
    inheritedFrom: Optional[PydanticObjectId] = Field(default=None, pattern=r"^[0-9a-fA-F]{24}$")
    grantedBy: Optional[PydanticObjectId] = Field(default=None, pattern=r"^[0-9a-fA-F]{24}$")  # references IUser collection
    grantedAt: datetime = Field(default_factory=lambda: datetime.now(timezone.utc))
    createdAt: Optional[datetime] = Field(default=None)  # auto-generated by Beanie
    updatedAt: Optional[datetime] = Field(default=None)  # auto-generated by Beanie
```

### Service Design

ACL Service - `mcp-gateway-registry/registry/services/aclService.py`

```python 
import logging
from packages.models._generated.aclEntry import IAclEntry
from packages.models._generated.user import IUser

class ACLService: 
    """Service class for administering connector-level access control policies"""

    async def grant_permission(
        self,
        principal_type: str,
        principal_id: Optional[Union[str, ObjectId]],
        resource_type: str,
        resource_id: Union[str, ObjectId],
        access_role_id: str,
        granted_by: Union[str, ObjectId],
        session: Optional[Any] = None,
        role_id: Optional[Union[str, ObjectId]] = None
    ) -> IAclEntry: 
    """
    Grant a permission to a principal for a resource using a role.
    Returns the created or updated ACL entry.
    """

    def find_accessible_resources(
        self,
        user_id: str,
        role: str,
        resource_type: str,
        required_permissions: int
    ) -> List[ObjectId]:
    """
    Find all resources of a specific type that a user has access to with specific permission bits.
    Returns a list of resource IDs.
    """


    def find_publicly_accessible_resources(
        self,
        resource_type: str,
        required_permissions: int
    ) -> List[ObjectId]:
    """
    Find all publicly accessible resources of a specific type.
    Returns a list of resource IDs.
    """

    def get_resource_permissions_map(
        self,
        user_id: str,
        role: str,
        resource_type: str,
        resource_ids: List[Union[str, ObjectId]]
    ) -> Dict[str, int]:
    """
    Get effective permissions for multiple resources in a batch operation.
    Returns a map of resourceId to permission bits.
    """

    def remove_all_permissions(
        self,
        resource_type: str,
        resource_id: Union[str, ObjectId]
    ) -> Dict:
    """
    Remove all permissions for a resource (cleanup when resource is deleted).
    Returns result of the deletion operation.
    """

    def check_permission(
        self,
        user_id: str,
        role: Optional[str],
        resource_type: str,
        resource_id: Union[str, ObjectId],
        required_permission: int
    ) -> bool:
    """
    Check if a user has specific permission bits on a resource.
    Returns True if user has required permission, else False.
    """

    def _validate_resource_type(self, resource_type: str) -> None:
    """
    Validates that the resourceType is one of the supported enum values.
    Raises an error if not valid.
    """

```

### ACL API

TBD - Does this service need to expose an API or will it be primarily used internally by server & agent endpoints?

## Jarvis API Integration

Assuming we are porting server registration to the registry project:

`jarvis-api/packages/api/src/mcp/registry/MCPServersRegistry.ts`

```TypeScript
private readonly dbConfigsRepo: IServerConfigsRepositoryInterface; // Eventually should point to /v1/server endpoint
private readonly cacheConfigsRepo: IServerConfigsRepositoryInterface;
private readonly allowedDomains?: string[] | null;
private readonly readThroughCache: Keyv<t.ParsedServerConfig>;
private readonly readThroughCacheAll: Keyv<Record<string, t.ParsedServerConfig>>;
```

## Questions: 
1. Will MCP server regsitration functionality stay in Jarvis or will it move to registry project?

